<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>クイズゲーム</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .animate-pulse {
      animation: pulse 1s infinite;
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    .result-overlay {
      position: fixed;
      top: 20%;
      left: 50%;
      transform: translateX(-50%);
      z-index: 55;
      background: rgba(0, 0, 0, 0.8);
      padding: 1rem 2rem;
      border-radius: 0.75rem;
      color: white;
      font-size: 4rem;
      font-weight: bold;
      text-align: center;
    }
    .phase-tab.active {
      border-color: #3b82f6; /* blue-500 */
      color: #60a5fa; /* blue-400 */
    }
    .game-over-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 60;
      color: red;
      font-size: 8rem;
      font-weight: bold;
      text-shadow: 0 0 20px rgba(255, 0, 0, 0.5);
    }
    .selected-answer-center {
      position: fixed !important;
      top: 50% !important;
      left: 50% !important;
      transform: translate(-50%, -50%) !important;
      z-index: 100 !important;
      transition: all 0.3s ease-in-out;
    }
    .start-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      z-index: 30;
      color: white;
      font-size: 4rem;
      font-weight: bold;
    }
    #start-button, #start-settings-button, #detailed-background-button {
      z-index: 35;
      pointer-events: auto !important;
    }

    #question-display {
      display: block !important;
      opacity: 1 !important;
      pointer-events: auto !important;
    }
    #answer-container {
      display: flex;
      flex-direction: row;
      justify-content: space-around;
      align-items: center;
      min-height: 400px;
      position: relative;
      background: rgba(0, 0, 0, 0.2);
      border-radius: 1rem;
      overflow: hidden;
      z-index: 10;
    }

    #countdown {
      position: relative;
      z-index: 10;
      text-align: center;
      font-size: 4rem;
      font-weight: bold;
      color: white;
      background: rgba(0, 0, 0, 0.75);
      padding: 0.5rem 1rem;
      border-radius: 0.75rem;
    }
    button {
      pointer-events: auto !important;
    }
    .fly-in {
      animation: flyIn 1s ease-out forwards;
      transform-origin: center;
      pointer-events: none;
    }
    .animate-fly-in {
      animation: flyIn 0.6s ease-out forwards;
    }
    @keyframes flyIn {
      0% {
        transform: translateZ(-1000px) scale(0.5);
        opacity: 0;
      }
      100% {
        transform: translateZ(0) scale(1);
        opacity: 1;
      }
    }
    .disabled-answer {
      opacity: 0.5;
      cursor: not-allowed;
      pointer-events: none !important;
    }
    .enabled-answer {
      animation: enablePulse 0.5s ease-in-out 2;
    }
    @keyframes enablePulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    .clicked-answer {
      background-color: #3b82f6 !important; /* Tailwindのbg-blue-500 */
      transform: scale(1.2);
      transition: transform 0.2s ease-in-out;
      box-shadow: 0 10px 20px rgba(0, 0, 0, 0.5);
    }
    .selected-answer {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      z-index: 50;
      transition: all 0.5s ease-in-out;
    }
    #settings-button-container {
      z-index: 10;
      width: 100%;
      max-width: 1280px;
      display: flex;
      justify-content: center;
      gap: 1rem;
      margin-bottom: 1rem;
    }
  </style>
</head>
<body class="bg-gray-900 text-white font-sans min-h-screen flex flex-col items-center justify-start p-8 relative">
  <!-- Background Elements -->
  <video autoplay muted loop playsinline id="background-video" class="absolute top-0 left-0 w-full h-full object-cover -z-10"></video>
  <div id="background-image" class="absolute top-0 left-0 w-full h-full bg-cover bg-center -z-10 hidden"></div>
  <div id="start-screen" class="fixed inset-0 bg-black bg-opacity-95 flex-col justify-center items-center z-30 text-white text-6xl font-bold flex">
    <h1 class="mb-12">クイズゲーム</h1>
    <button id="start-button" class="bg-green-600 hover:bg-green-800 text-white font-bold py-6 px-12 rounded-2xl text-5xl transition-colors mb-8">
      スタート
    </button>
    <div class="flex gap-4 mt-8">
      <button id="start-settings-button" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors">設定の変更</button>
      <button id="detailed-background-button" class="bg-gray-600 hover:bg-gray-800 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors">背景の設定</button>
    </div>
    
  </div>

  <div id="settings-button-container" class="w-full max-w-6xl z-10 hidden mb-4">
      <div class="flex justify-center gap-4">
        <button
          id="toggle-settings-form"
          class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-2 px-4 rounded-lg transition-colors"
        >
          設定を変更
        </button>
        <button
          id="toggle-background-form-ingame"
          class="bg-gray-600 hover:bg-gray-800 text-white font-bold py-2 px-4 rounded-lg transition-colors"
        >
          背景の設定
        </button>

      </div>
  </div>
  <div id="quiz-container" class="w-full max-w-6xl z-10">
    <h2 id="question-display" class="text-4xl mb-8 font-semibold text-center bg-gray-800 bg-opacity-75 px-8 py-4 rounded-xl hidden">問題 1: 地球上で最大の大陸は？</h2>
    <div id="correct-feedback" class="hidden relative z-[110] text-green-400 text-6xl font-bold text-center py-4" style="text-shadow: 0 0 15px rgba(0, 255, 0, 0.7);">正解</div>
    <div id="complete-message" class="text-center hidden mb-12 w-full z-10">
      <p class="text-6xl font-bold text-green-500 bg-gray-800 px-12 py-4 rounded-xl shadow-lg">
        全問正解！
      </p>
      <button id="try-again-complete" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-4 px-8 rounded-xl mt-8 text-3xl">
        もう一度挑戦
      </button>
    </div>
    <div id="answer-container" class="flex flex-row justify-around items-center w-full mt-8 transition-opacity duration-500 ease-in-out hidden">
        <button id="answer1-btn" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-12 px-12 rounded-xl text-4xl w-[400px] h-[400px] flex items-center justify-center">
          アフリカ
        </button>
        <div id="countdown" class="text-4xl font-bold text-white bg-gray-800 bg-opacity-75 px-6 py-3 rounded-xl hidden">5</div>
        <button id="answer2-btn" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-12 px-12 rounded-xl text-4xl w-[400px] h-[400px] flex items-center justify-center">
          ユーラシア大陸
        </button>
    </div>
  </div>
  <div id="game-over" class="game-over-screen hidden">
    <p>ゲームオーバー</p>
    <button id="try-again" class="bg-blue-600 hover:bg-blue-800 text-white font-bold py-4 px-8 rounded-xl text-3xl mt-8">
      もう一度挑戦
    </button>
  </div>

  <!-- Quiz Settings Form Container -->
  <div id="settings-form-container" class="hidden fixed inset-0 bg-black bg-opacity-80 flex justify-center items-center z-40">
    <div id="settings-form" class="bg-gray-800 p-8 rounded-lg text-white w-full max-w-4xl max-h-[90vh] flex flex-col border-4 border-blue-500 shadow-2xl">
      <div class="flex justify-between items-center mb-6">
        <h3 class="text-3xl font-bold">設定の変更</h3>
        <button id="close-settings-form" class="text-3xl font-bold">&times;</button>
      </div>

      <div class="flex-grow overflow-y-auto pr-4">
        <!-- Question Management -->
        <div class="mb-8">
          <h4 class="text-2xl mb-4">問題の管理</h4>
          <div class="flex gap-4">
            <label for="import-questions" class="bg-green-600 hover:bg-green-800 text-white font-bold py-2 px-4 rounded-lg cursor-pointer transition-colors">問題と背景のインポート</label>
            <input type="file" id="import-questions" class="hidden" accept=".json">
            <button id="export-questions" class="bg-purple-600 hover:bg-purple-800 text-white font-bold py-2 px-4 rounded-lg transition-colors">問題と背景のエクスポート</button>
          </div>
        </div>

        <!-- Question Editor -->
        <div>
          <h4 class="text-2xl mb-4">問題の編集</h4>
          <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
            <!-- Left: Question List -->
            <div id="question-list" class="bg-gray-700 p-4 rounded-lg overflow-y-auto h-96">
              <!-- Questions will be populated by JS -->
            </div>

            <!-- Right: Edit Form -->
            <div class="flex flex-col gap-4">
              <div>
                <label for="question-number" class="block mb-2">編集する問題:</label>
                <select id="question-number" class="w-full p-2 bg-gray-900 rounded"></select>
              </div>
              <div>
                <label for="question-text" class="block mb-2">問題文:</label>
                <textarea id="question-text" rows="3" class="w-full p-2 bg-gray-900 rounded"></textarea>
              </div>
              <div>
                <label for="answer1-text" class="block mb-2">選択肢1:</label>
                <input type="text" id="answer1-text" class="w-full p-2 bg-gray-900 rounded">
              </div>
              <div>
                <label for="answer2-text" class="block mb-2">選択肢2:</label>
                <input type="text" id="answer2-text" class="w-full p-2 bg-gray-900 rounded">
              </div>
              <div>
                <span class="block mb-2">正解の選択肢:</span>
                <div class="flex gap-4">
                  <label><input type="radio" name="correct-answer" value="1" class="mr-2">選択肢1</label>
                  <label><input type="radio" name="correct-answer" value="2" class="mr-2">選択肢2</label>
                </div>
              </div>
              <button id="change-question" class="bg-yellow-600 hover:bg-yellow-800 text-white font-bold py-3 px-6 rounded-lg text-xl transition-colors mt-4">問題を更新</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Detailed Background Settings Form -->
  <div id="detailed-background-form" class="hidden fixed inset-0 bg-black bg-opacity-90 flex justify-center items-center z-50">
    <div class="bg-gray-800 p-8 rounded-lg text-white w-full max-w-4xl max-h-[90vh] flex flex-col border-4 border-purple-500 shadow-2xl">
        <div class="flex justify-between items-center mb-6">
            <h3 class="text-3xl font-bold">背景の詳細設定</h3>
            <button id="close-detailed-background-form" class="text-3xl font-bold">&times;</button>
        </div>
        <div class="flex-grow overflow-y-auto grid grid-cols-1 md:grid-cols-2 gap-6 p-1">
            <!-- 全体・デフォルト設定 -->
            <div class="flex flex-col gap-4">
                <h3 class="text-lg font-semibold border-b-2 border-gray-600 pb-2">全体・デフォルト設定</h3>
                <div id="global-background-settings" class="flex flex-col gap-3">
                    <!-- JSがここにコントロールを生成 -->
                </div>
            </div>

            <!-- 問題ごとの個別設定 -->
            <div class="flex flex-col gap-4">
                <div class="flex justify-between items-center border-b-2 border-gray-600 pb-2">
                    <h3 class="text-lg font-semibold">問題ごとの個別設定</h3>
                    <select id="bg-question-select" class="bg-gray-700 border border-gray-600 rounded-md px-2 py-1 text-sm">
                        <!-- JSがここに問題を生成 -->
                    </select>
                </div>
                <div id="specific-question-background-settings" class="flex flex-col gap-3">
                    <!-- JSがここにコントロールを生成 -->
                </div>
            </div>
        </div>
        <input type="file" id="background-file-input" class="hidden" accept="video/*,image/*">
    </div>
  </div>

  <script>
document.addEventListener('DOMContentLoaded', () => {
    // 1. DOM ELEMENT REFERENCES
    const elements = {
        backgroundVideo: document.getElementById('background-video'),
        backgroundImage: document.getElementById('background-image'),
        startScreen: document.getElementById('start-screen'),
        startButton: document.getElementById('start-button'),
        quizContainer: document.getElementById('quiz-container'),
        questionDisplay: document.getElementById('question-display'),
        answerContainer: document.getElementById('answer-container'),
        answer1Button: document.getElementById('answer1-btn'),
        answer2Button: document.getElementById('answer2-btn'),
        correctFeedback: document.getElementById('correct-feedback'),
        gameOverMessage: document.getElementById('game-over'),
        completeMessage: document.getElementById('complete-message'),
        tryAgainButton: document.getElementById('try-again'),
        tryAgainCompleteButton: document.getElementById('try-again-complete'),
        startSettingsButton: document.getElementById('start-settings-button'),
        settingsButtonContainer: document.getElementById('settings-button-container'),
        toggleSettingsForm: document.getElementById('toggle-settings-form'),
        toggleBackgroundFormIngameButton: document.getElementById('toggle-background-form-ingame'),
        settingsFormContainer: document.getElementById('settings-form-container'),
        closeSettingsFormButton: document.getElementById('close-settings-form'),
        importQuestionsInput: document.getElementById('import-questions'),
        exportQuestionsButton: document.getElementById('export-questions'),
        questionList: document.getElementById('question-list'),
        questionNumberSelect: document.getElementById('question-number'),
        questionTextInput: document.getElementById('question-text'),
        answer1TextInput: document.getElementById('answer1-text'),
        answer2TextInput: document.getElementById('answer2-text'),
        changeQuestionButton: document.getElementById('change-question'),
        detailedBackgroundButton: document.getElementById('detailed-background-button'),
        detailedBackgroundForm: document.getElementById('detailed-background-form'),
        closeDetailedBackgroundForm: document.getElementById('close-detailed-background-form'),
        globalBgSettingsContainer: document.getElementById('global-background-settings'),
        specificQuestionBgSettingsContainer: document.getElementById('specific-question-background-settings'),
        bgQuestionSelect: document.getElementById('bg-question-select'),
        backgroundFileInput: document.getElementById('background-file-input'),
    };

    // 2. APPLICATION STATE
    let questions = [];
    let currentQuestionIndex = 0;
    let backgroundObjectURLs = {};
    let currentBgContext = null;

    let globalBackgrounds = {
        startScreen: { type: 'color', value: '#000000', label: 'スタート画面' },
        preQuiz: { type: 'color', value: '#111111', label: '問題の合間' },
        quiz: { type: 'color', value: '#222222', label: 'クイズ中' },
        result: { type: 'color', value: '#333333', label: '結果表示中' },
        correctAnswerWait: { type: 'color', value: '#1a202c', label: '正解後待ち時間' },
        incorrectAnswerWait: { type: 'color', value: '#2d3748', label: '不正解後待ち時間' },
        gameComplete: { type: 'color', value: '#2c5282', label: '全問正解' },
        gameOver: { type: 'color', value: '#c53030', label: 'ゲームオーバー' }
    };

    function initializeQuestions() {
        questions = [
            { question: "地球上で最大の大陸は？", answer1: "アフリカ", answer2: "ユーラシア大陸", correctAnswer: 2, time: 5 },
            { question: "日本の首都は？", answer1: "東京", answer2: "大阪", correctAnswer: 1, time: 5 },
            { question: "1+1は？", answer1: "2", answer2: "11", correctAnswer: 1, time: 5 },
            { question: "世界で一番高い山は？", answer1: "エベレスト", answer2: "富士山", correctAnswer: 1, time: 5 },
            { question: "太陽系で最大の惑星は？", answer1: "地球", answer2: "木星", correctAnswer: 2, time: 5 },
        ].map(q => ({ ...q, backgrounds: { preQuiz: null, quiz: null, result: null, correctAnswerWait: null, incorrectAnswerWait: null } }));
    }

    // 3. FUNCTIONS

    // --- UI & Display ---
    function setScreen(activeScreen) {
        [elements.startScreen, elements.quizContainer, elements.gameOverMessage, elements.completeMessage, elements.settingsButtonContainer].forEach(s => s.classList.add('hidden'));
        if (activeScreen) activeScreen.classList.remove('hidden');
    }

    // --- Background Management ---
    function getBackgroundForState(phase, qIndex = -1) {
        // Check for specific question background first
        if (qIndex >= 0 && qIndex < questions.length) {
            const q = questions[qIndex];
            if (q?.backgrounds?.[phase]) {
                return q.backgrounds[phase];
            }
        }
        // Fallback to global/default background
        if (globalBackgrounds[phase]) {
            return globalBackgrounds[phase];
        }
        // Ultimate fallback
        return { type: 'color', value: '#000' };
    }

    function applyBackground(phase, qIndex = currentQuestionIndex) {
        const bg = getBackgroundForState(phase, qIndex);
        elements.backgroundVideo.classList.add('hidden');
        elements.backgroundImage.classList.add('hidden');
        document.body.style.backgroundColor = '';

        if (bg.type === 'video' && bg.src) {
            elements.backgroundVideo.src = bg.src;
            elements.backgroundVideo.classList.remove('hidden');
            elements.backgroundVideo.play().catch(e => console.error("Video play failed:", e));
        } else if (bg.type === 'image' && bg.src) {
            elements.backgroundImage.style.backgroundImage = `url(${bg.src})`;
            elements.backgroundImage.classList.remove('hidden');
        } else { // color
            document.body.style.backgroundColor = bg.value;
        }
    }

    function createBackgroundControl(label, context) {
        const { type, key, qIndex } = context;
        let bg;
        let isDefault = false;

        if (type === 'specific') {
            bg = questions[qIndex]?.backgrounds?.[key];
            if (!bg) {
                isDefault = true;
                bg = globalBackgrounds[key];
            }
        } else { // 'global' type now covers all defaults
            bg = globalBackgrounds[key];
        }

        let preview = '未設定';
        if (bg) {
            if (bg.type === 'video') preview = '動画';
            else if (bg.type === 'image') preview = '画像';
            else if (bg.type === 'color') preview = '色';
        }

        const container = document.createElement('div');
        container.className = 'bg-gray-700 p-3 rounded-lg flex flex-col gap-2';
        container.innerHTML = `
            <span class="font-bold">${label}</span>
            <div class="text-sm text-gray-400">現在: ${preview}</div>
            <div class="flex gap-2 mt-auto">
                <button data-context='${JSON.stringify(context)}' class="bg-blue-600 hover:bg-blue-800 text-white text-xs py-1 px-2 rounded-lg flex-1 set-bg-url">URL</button>
                <button data-context='${JSON.stringify(context)}' class="bg-green-600 hover:bg-green-800 text-white text-xs py-1 px-2 rounded-lg flex-1 set-bg-file">File</button>
                ${type === 'specific' ? `<button data-context='${JSON.stringify(context)}' class="bg-red-600 hover:bg-red-800 text-white text-xs py-1 px-2 rounded-lg flex-1 reset-bg">Reset</button>` : ''}
            </div>`;
        return container;
    }

    function renderBackgroundSettings() {
        elements.globalBgSettingsContainer.innerHTML = '';
        const globalKeysToShow = ['startScreen', 'correctAnswerWait', 'incorrectAnswerWait', 'gameComplete', 'gameOver'];
        globalKeysToShow.forEach(key => {
            if (globalBackgrounds[key]) {
                elements.globalBgSettingsContainer.appendChild(createBackgroundControl(globalBackgrounds[key].label, { type: 'global', key }));
            }
        });

        elements.bgQuestionSelect.innerHTML = '';
        questions.forEach((_, i) => {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = `問題 ${i + 1}`;
            elements.bgQuestionSelect.appendChild(option);
        });

        renderSpecificQuestionBgSettings();
    }

    function renderSpecificQuestionBgSettings() {
        const qIndex = parseInt(elements.bgQuestionSelect.value, 10);
        elements.specificQuestionBgSettingsContainer.innerHTML = '';
        if (isNaN(qIndex) || qIndex >= questions.length) return;

        const questionPhaseKeys = ['preQuiz', 'quiz', 'result', 'correctAnswerWait', 'incorrectAnswerWait'];
        questionPhaseKeys.forEach(key => {
            const label = globalBackgrounds[key].label;
            elements.specificQuestionBgSettingsContainer.appendChild(createBackgroundControl(label, { type: 'specific', key, qIndex }));
        });
    }

    function handleBackgroundChange(context, value, type) {
        const { type: contextType, key, qIndex } = context;
        const newBg = { type, src: value };
        if (type === 'color') newBg.value = value;

        if (contextType === 'global') {
            globalBackgrounds[key] = newBg;
        } else if (contextType === 'specific') {
            questions[qIndex].backgrounds[key] = newBg;
        }

        renderBackgroundSettings();
    }

    function handleBackgroundFileChange(event) {
        const file = event.target.files[0];
        if (!file || !currentBgContext) return;

        const url = URL.createObjectURL(file);
        const type = file.type.startsWith('video/') ? 'video' : 'image';

        const fullKey = `${currentBgContext.type}-${currentBgContext.key}` + (currentBgContext.qIndex !== undefined ? `-${currentBgContext.qIndex}` : '');
        if (backgroundObjectURLs[fullKey]) {
            URL.revokeObjectURL(backgroundObjectURLs[fullKey]);
        }
        backgroundObjectURLs[fullKey] = url;

        handleBackgroundChange(currentBgContext, url, type);
        elements.backgroundFileInput.value = ''; // Reset file input
    }

    // --- Quiz Game Logic ---
    function handleStart() {
        setScreen(elements.settingsButtonContainer);
        applyBackground('preQuiz', 0);
        setTimeout(() => {
            nextQuestion();
        }, 5000);
    }

    function handleAnswer(selectedAnswer) {
        const correct = selectedAnswer === questions[currentQuestionIndex].correctAnswer;
        const selectedButton = selectedAnswer === 1 ? elements.answer1Button : elements.answer2Button;
        const otherButton = selectedAnswer === 1 ? elements.answer2Button : elements.answer1Button;

        // Disable buttons and move selected one to center
        elements.answer1Button.disabled = true;
        elements.answer2Button.disabled = true;
        selectedButton.classList.add('selected-answer-center');
        otherButton.classList.add('hidden');

        if (correct) {
            applyBackground('correctAnswerWait');
            // Wait 3 seconds before showing the result
            setTimeout(() => {
                applyBackground('result'); // Apply result background ONLY for correct answer
                elements.correctFeedback.textContent = '正解';
                elements.correctFeedback.classList.remove('text-red-400');
                elements.correctFeedback.classList.add('text-green-400');
                elements.correctFeedback.classList.remove('hidden');

                // After showing "Correct", wait 2 seconds then proceed
                setTimeout(() => {
                    elements.correctFeedback.classList.add('hidden');
                    elements.quizContainer.classList.add('hidden');
                    
                    // Reset buttons
                    selectedButton.classList.remove('selected-answer-center');
                    otherButton.classList.remove('hidden');
                    elements.answer1Button.disabled = false;
                    elements.answer2Button.disabled = false;

                    currentQuestionIndex++;
                    if (currentQuestionIndex < questions.length) {
                        // Show interval screen and background for 5 seconds
                        setScreen(elements.settingsButtonContainer);
                        applyBackground('preQuiz');
                        setTimeout(nextQuestion, 5000);
                    } else {
                        // Game complete
                        setScreen(elements.completeMessage);
                        applyBackground('gameComplete');
                    }
                }, 2000); // Duration to show "Correct" feedback
            }, 3000); // Wait 3 seconds after answer selection
        } else { // Incorrect
            applyBackground('incorrectAnswerWait');
            // Wait 5 seconds, then show Game Over. No feedback text.
            setTimeout(() => {
                setScreen(elements.gameOverMessage);
                applyBackground('gameOver');
                
                // Reset buttons for 'try again'
                selectedButton.classList.remove('selected-answer-center');
                otherButton.classList.remove('hidden');
            }, 5000); // Wait 5 seconds before showing game over screen
        }
    }

    function nextQuestion() {
        if (currentQuestionIndex >= questions.length) {
            setScreen(elements.completeMessage);
            applyBackground('gameComplete');
            return;
        }

        applyBackground('quiz');
        setScreen(elements.quizContainer);

        const question = questions[currentQuestionIndex];
        elements.questionDisplay.textContent = `問題 ${currentQuestionIndex + 1}: ${question.question}`;
        elements.answer1Button.textContent = question.answer1;
        elements.answer2Button.textContent = question.answer2;

        elements.answer1Button.disabled = false;
        elements.answer2Button.disabled = false;
        elements.answer1Button.classList.remove('hidden', 'selected-answer-center');
        elements.answer2Button.classList.remove('hidden', 'selected-answer-center');
    }

    function resetGame() {
        currentQuestionIndex = 0;
        elements.answer1Button.classList.remove('selected-answer-center');
        elements.answer2Button.classList.remove('hidden');
        setScreen(elements.startScreen);
        applyBackground('startScreen', -1);
    }

    // --- Settings & Data Management ---
    function handleImportSettings(event) {
        const file = event.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (e) => {
            try {
                const data = JSON.parse(e.target.result);
                
                initializeQuestions(); // Fallback if import is partial
                Object.assign(questions, data.questions || {});
                Object.assign(globalBackgrounds, data.globalBackgrounds || {});

                resetGame();
                updateQuestionList();
                updateQuestionFormForSelectedIndex();
                alert('設定をインポートしました。');
            } catch (error) {
                alert('ファイルの読み込みに失敗しました。');
                console.error(error);
            }
        };
        reader.readAsText(file);
    }

    function handleExportSettings() {
        const exportableData = { questions: [], globalBackgrounds: {} };

        const processBg = (bg) => {
            if (bg && bg.src && bg.src.startsWith('blob:')) return null;
            return bg;
        };

        exportableData.questions = questions.map(q => {
            const processedBgs = {};
            for (const key in q.backgrounds) {
                processedBgs[key] = processBg(q.backgrounds[key]);
            }
            return { ...q, backgrounds: processedBgs };
        });

        Object.keys(globalBackgrounds).forEach(key => { exportableData.globalBackgrounds[key] = processBg(globalBackgrounds[key]); });

        const blob = new Blob([JSON.stringify(exportableData, null, 2)], { type: 'application/json' });
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url;
        a.download = 'quiz-settings.json';
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
    }

    function updateQuestionList() {
        elements.questionList.innerHTML = '';
        questions.forEach((q, index) => {
            const div = document.createElement('div');
            div.textContent = `問題 ${index + 1}: ${q.question.substring(0, 20)}...`;
            div.className = 'p-2 rounded cursor-pointer hover:bg-gray-600';
            div.onclick = () => {
                elements.questionNumberSelect.value = index;
                updateQuestionFormForSelectedIndex();
            };
            elements.questionList.appendChild(div);
        });

        elements.questionNumberSelect.innerHTML = '';
        questions.forEach((q, index) => {
            const option = document.createElement('option');
            option.value = index;
            option.textContent = `問題 ${index + 1}`;
            elements.questionNumberSelect.appendChild(option);
        });
    }

    function updateQuestionFormForSelectedIndex() {
        const index = elements.questionNumberSelect.value;
        if (index < 0 || index >= questions.length) return;

        const q = questions[index];
        elements.questionTextInput.value = q.question;
        elements.answer1TextInput.value = q.answer1;
        elements.answer2TextInput.value = q.answer2;
        const correctAnswerRadio = document.querySelector(`input[name="correct-answer"][value="${q.correctAnswer}"]`);
        if (correctAnswerRadio) correctAnswerRadio.checked = true;
    }

    function handleChangeQuestion() {
        const index = elements.questionNumberSelect.value;
        if (index < 0 || index >= questions.length) return;

        const correctAnswerInput = document.querySelector('input[name="correct-answer"]:checked');
        if (!correctAnswerInput) {
            alert('正解の選択肢を選んでください。');
            return;
        }

        questions[index] = {
            ...questions[index],
            question: elements.questionTextInput.value,
            answer1: elements.answer1TextInput.value,
            answer2: elements.answer2TextInput.value,
            correctAnswer: parseInt(correctAnswerInput.value, 10),
        };

        updateQuestionList();
        alert(`問題 ${parseInt(index, 10) + 1} が更新されました。`);
    }

    // 4. EVENT LISTENERS
    function setupEventListeners() {
        elements.startButton.addEventListener('click', handleStart);
        elements.answer1Button.addEventListener('click', () => handleAnswer(1));
        elements.answer2Button.addEventListener('click', () => handleAnswer(2));
        elements.tryAgainButton.addEventListener('click', resetGame);
        elements.tryAgainCompleteButton.addEventListener('click', resetGame);

        const showSettings = () => {
            elements.settingsFormContainer.classList.remove('hidden');
            updateQuestionList();
            updateQuestionFormForSelectedIndex();
        };
        elements.startSettingsButton.addEventListener('click', showSettings);
        elements.toggleSettingsForm.addEventListener('click', showSettings);
        elements.closeSettingsFormButton.addEventListener('click', () => elements.settingsFormContainer.classList.add('hidden'));

        const showBgSettings = () => {
            renderBackgroundSettings();
            elements.detailedBackgroundForm.classList.remove('hidden');
        };
        elements.detailedBackgroundButton.addEventListener('click', showBgSettings);
        elements.toggleBackgroundFormIngameButton.addEventListener('click', showBgSettings);
        elements.closeDetailedBackgroundForm.addEventListener('click', () => elements.detailedBackgroundForm.classList.add('hidden'));

        elements.importQuestionsInput.addEventListener('change', handleImportSettings);
        elements.exportQuestionsButton.addEventListener('click', handleExportSettings);
        elements.questionNumberSelect.addEventListener('change', updateQuestionFormForSelectedIndex);
        elements.changeQuestionButton.addEventListener('click', handleChangeQuestion);

        elements.bgQuestionSelect.addEventListener('change', renderSpecificQuestionBgSettings);
        elements.backgroundFileInput.addEventListener('change', handleBackgroundFileChange);

        elements.detailedBackgroundForm.addEventListener('click', (e) => {
            const button = e.target.closest('button[data-context]');
            if (!button) return;
            const context = JSON.parse(button.dataset.context);

            if (button.classList.contains('set-bg-file')) {
                currentBgContext = context;
                elements.backgroundFileInput.click();
            } else if (button.classList.contains('set-bg-url')) {
                const url = prompt('背景のURLを入力してください (動画または画像):');
                if (url) {
                    const type = (url.match(/\.(jpeg|jpg|gif|png)$/) != null) ? 'image' : 'video';
                    handleBackgroundChange(context, url, type);
                }
            } else if (button.classList.contains('reset-bg')) {
                 if (context.type === 'specific') {
                    questions[context.qIndex].backgrounds[context.key] = null;
                    renderSpecificQuestionBgSettings();
                }
            }
        });
    }

    // 5. INITIALIZATION
    function main() {
        initializeQuestions();
        setupEventListeners();
        resetGame();
        updateQuestionList();
        updateQuestionFormForSelectedIndex();
    }

    main();
});
  </script>
</body>
</html>
